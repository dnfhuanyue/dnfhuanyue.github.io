var tape=require("tape"),on=require("../../../lib/events/on"),trigger=require("../../../lib/events/trigger"),attachForm=require("../../../lib/proto/attach-form"),attr="data-pjax-state";tape("test attach form prototype method",(function(t){var form=document.createElement("form"),loadUrlCalled=!1;attachForm.call({options:{currentUrlFullReload:!0},loadUrl:function(){loadUrlCalled=!0}},form);var internalUri=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search;form.action="http://external.com/",trigger(form,"submit"),t.equal(form.getAttribute(attr),"external","external url stop behavior"),form.action=internalUri+"#anchor",trigger(form,"submit"),t.equal(form.getAttribute(attr),"anchor","internal anchor stop behavior"),window.location.hash="#anchor",form.action=internalUri+"#another-anchor",trigger(form,"submit"),t.equal(form.getAttribute(attr),"anchor","different anchors stop behavior"),window.location.hash="",form.action=internalUri+"#",trigger(form,"submit"),t.equal(form.getAttribute(attr),"anchor-empty","empty anchor stop behavior"),form.action=window.location.href,trigger(form,"submit"),t.equal(form.getAttribute(attr),"reload","submitting when currentUrlFullReload is true will submit normally, without XHR"),t.equal(loadUrlCalled,!1,"loadUrl() not called"),form.action=window.location.protocol+"//"+window.location.host+"/internal",form.method="POST",trigger(form,"submit"),t.equal(form.getAttribute(attr),"submit","triggering a POST request to the next page"),t.equal(loadUrlCalled,!0,"loadUrl() called correctly"),loadUrlCalled=!1,form.setAttribute(attr,""),form.action=window.location.protocol+"//"+window.location.host+"/internal",form.method="GET",trigger(form,"submit"),t.equal(form.getAttribute(attr),"submit","triggering a GET request to the next page"),t.equal(loadUrlCalled,!0,"loadUrl() called correctly"),t.end()})),tape("test attach form preventDefaulted events",(function(t){var loadUrlCalled=!1,form=document.createElement("form");on(form,"submit",(function(event){event.preventDefault()})),attachForm.call({options:{},loadUrl:function(){loadUrlCalled=!0}},form),form.action="#",trigger(form,"submit"),t.equal(loadUrlCalled,!1,"events that are preventDefaulted should not fire callback"),t.end()})),tape("test options are not modified by attachForm",(function(t){var form=document.createElement("form"),options={foo:"bar"};attachForm.call({options:options,loadUrl:function(){}},form),form.action=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search,form.method="GET",trigger(form,"submit"),t.equal(1,Object.keys(options).length,"options object that is passed in should not be modified"),t.equal("bar",options.foo,"options object that is passed in should not be modified"),t.end()})),tape("test form elements parsed correctly",(function(t){t.plan(1);var form=document.createElement("form"),input=document.createElement("input");input.name="input",input.value="value",form.appendChild(input);var params=[{name:"input",value:"value"}],pjax={options:{},loadUrl:function(href,options){t.same(options.requestOptions.requestParams,params,"form elements parsed correctly")}};attachForm.call(pjax,form),form.action=window.location.protocol+"//"+window.location.host+"/internal",trigger(form,"submit"),t.end()})),tape('test form.enctype="multipart/form-data"',(function(t){t.plan(4);var form=document.createElement("form");form.enctype="multipart/form-data";var input=document.createElement("input");input.name="input",input.value="value",form.appendChild(input);var pjax={options:{},loadUrl:function(href,options){t.equals(options.requestOptions.requestParams,void 0,"form elements not parsed manually"),t.true(options.requestOptions.formData instanceof FormData,"requestOptions.formData is a FormData"),t.equals(Array.from(options.requestOptions.formData.entries()).length,1,"correct number of FormData elements"),t.equals(options.requestOptions.formData.get("input"),"value","FormData element value set correctly")}};attachForm.call(pjax,form),form.action=window.location.protocol+"//"+window.location.host+"/internal",trigger(form,"submit"),t.end()}));