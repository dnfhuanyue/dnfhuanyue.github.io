var forEachEls=require("./lib/foreach-els"),parseOptions=require("./lib/parse-options"),switches=require("./lib/switches"),newUid=require("./lib/uniqueid"),on=require("./lib/events/on"),trigger=require("./lib/events/trigger"),clone=require("./lib/util/clone"),contains=require("./lib/util/contains"),extend=require("./lib/util/extend"),noop=require("./lib/util/noop"),Pjax=function(options){this.state={numPendingSwitches:0,href:null,options:null},this.options=parseOptions(options),this.log("Pjax options",this.options),this.options.scrollRestoration&&"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.maxUid=this.lastUid=newUid(),this.parseDOM(document),on(window,"popstate",function(st){if(st.state){var opt=clone(this.options);opt.url=st.state.url,opt.title=st.state.title,opt.history=!1,opt.scrollPos=st.state.scrollPos,st.state.uid<this.lastUid?opt.backward=!0:opt.forward=!0,this.lastUid=st.state.uid,this.loadUrl(st.state.url,opt)}}.bind(this))};if(Pjax.switches=switches,Pjax.prototype={log:require("./lib/proto/log"),getElements:function(el){return el.querySelectorAll(this.options.elements)},parseDOM:function(el){var parseElement=require("./lib/proto/parse-element");forEachEls(this.getElements(el),parseElement,this)},refresh:function(el){this.parseDOM(el||document)},reload:function(){window.location.reload()},attachLink:require("./lib/proto/attach-link"),attachForm:require("./lib/proto/attach-form"),forEachSelectors:function(cb,context,DOMcontext){return require("./lib/foreach-selectors").bind(this)(this.options.selectors,cb,context,DOMcontext)},switchSelectors:function(selectors,fromEl,toEl,options){return require("./lib/switches-selectors").bind(this)(this.options.switches,this.options.switchesOptions,selectors,fromEl,toEl,options)},latestChance:function(href){window.location=href},onSwitch:function(){trigger(window,"resize scroll"),this.state.numPendingSwitches--,0===this.state.numPendingSwitches&&this.afterAllSwitches()},loadContent:function(html,options){if("string"==typeof html){var tmpEl=document.implementation.createHTMLDocument("pjax"),matches=html.match(/<html[^>]+>/gi);if(matches&&matches.length&&(matches=matches[0].match(/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi)).length&&(matches.shift(),matches.forEach((function(htmlAttrib){var attr=htmlAttrib.trim().split("=");1===attr.length?tmpEl.documentElement.setAttribute(attr[0],!0):tmpEl.documentElement.setAttribute(attr[0],attr[1].slice(1,-1))}))),tmpEl.documentElement.innerHTML=html,this.log("load content",tmpEl.documentElement.attributes,tmpEl.documentElement.innerHTML.length),document.activeElement&&contains(document,this.options.selectors,document.activeElement))try{document.activeElement.blur()}catch(e){}this.switchSelectors(this.options.selectors,tmpEl,document,options)}else trigger(document,"pjax:complete pjax:error",options)},abortRequest:require("./lib/abort-request"),doRequest:require("./lib/send-request"),handleResponse:require("./lib/proto/handle-response"),loadUrl:function(href,options){options="object"==typeof options?extend({},this.options,options):clone(this.options),this.log("load href",href,options),this.abortRequest(this.request),trigger(document,"pjax:send",options),this.request=this.doRequest(href,options,this.handleResponse.bind(this))},afterAllSwitches:function(){var autofocusEl=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();autofocusEl&&document.activeElement!==autofocusEl&&autofocusEl.focus(),this.options.selectors.forEach((function(selector){forEachEls(document.querySelectorAll(selector),(function(el){}))}));var state=this.state;if(state.options.history&&(window.history.state||(this.lastUid=this.maxUid=newUid(),window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)),this.lastUid=this.maxUid=newUid(),window.history.pushState({url:state.href,title:state.options.title,uid:this.maxUid,scrollPos:[0,0]},state.options.title,state.href)),this.forEachSelectors((function(el){this.parseDOM(el)}),this),trigger(document,"pjax:complete pjax:success",state.options),"function"==typeof state.options.analytics&&state.options.analytics(),state.options.history){var a=document.createElement("a");if(a.href=this.state.href,a.hash){var name=a.hash.slice(1);name=decodeURIComponent(name);var curtop=0,target=document.getElementById(name)||document.getElementsByName(name)[0];if(target&&target.offsetParent)do{curtop+=target.offsetTop,target=target.offsetParent}while(target);window.scrollTo(0,curtop)}else!1!==state.options.scrollTo&&(state.options.scrollTo.length>1?window.scrollTo(state.options.scrollTo[0],state.options.scrollTo[1]):window.scrollTo(0,state.options.scrollTo))}else state.options.scrollRestoration&&state.options.scrollPos&&window.scrollTo(state.options.scrollPos[0],state.options.scrollPos[1]);this.state={numPendingSwitches:0,href:null,options:null}}},Pjax.isSupported=require("./lib/is-supported"),Pjax.isSupported())module.exports=Pjax;else{var stupidPjax=noop;for(var key in Pjax.prototype)Pjax.prototype.hasOwnProperty(key)&&"function"==typeof Pjax.prototype[key]&&(stupidPjax[key]=noop);module.exports=stupidPjax}