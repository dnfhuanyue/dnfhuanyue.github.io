window.addEventListener("DOMContentLoaded",()=>{let datas,isfetched=!1,isXml=!0,searchPath=CONFIG.path;0===searchPath.length?searchPath="search.xml":/json$/i.test(searchPath)&&(isXml=!1);const path=CONFIG.root+searchPath,input=document.getElementById("search-input"),resultContent=document.getElementById("search-result"),getIndexByWord=(word,text,caseSensitive)=>{let wordLen=word.length;if(0===wordLen)return[];let startPosition=0,position=[],index=[];for(caseSensitive||(text=text.toLowerCase(),word=word.toLowerCase());(position=text.indexOf(word,startPosition))>-1;)index.push({position:position,word:word}),startPosition=position+wordLen;return index},mergeIntoSlice=(start,end,index,searchText)=>{let item=index[index.length-1],{position:position,word:word}=item,hits=[],searchTextCountInSlice=0;for(;position+word.length<=end&&0!==index.length;){word===searchText&&searchTextCountInSlice++,hits.push({position:position,length:word.length});let wordEnd=position+word.length;for(index.pop();0!==index.length&&(item=index[index.length-1],position=item.position,word=item.word,wordEnd>position);)index.pop()}return{hits:hits,start:start,end:end,searchTextCount:searchTextCountInSlice}},highlightKeyword=(text,slice)=>{let result="",prevEnd=slice.start;return slice.hits.forEach(hit=>{result+=text.substring(prevEnd,hit.position);let end=hit.position+hit.length;result+=`<b class="search-keyword">${text.substring(hit.position,end)}</b>`,prevEnd=end}),result+=text.substring(prevEnd,slice.end),result},inputEventFunction=()=>{let searchText=input.value.trim().toLowerCase(),keywords=searchText.split(/[-\s]+/);keywords.length>1&&keywords.push(searchText);let resultItems=[];if(searchText.length>0&&datas.forEach(data=>{if(!data.title)return;let searchTextCount=0,title=data.title.trim(),titleInLowerCase=title.toLowerCase(),content=data.content?data.content.trim().replace(/<[^>]+>/g,""):"";CONFIG.localsearch.unescape&&(content=(html=>String(html).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x3A;/g,":").replace(/&#(\d+);/g,(m,p)=>String.fromCharCode(p)).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"))(content));let contentInLowerCase=content.toLowerCase(),articleUrl=decodeURIComponent(data.url).replace(/\/{2,}/g,"/"),indexOfTitle=[],indexOfContent=[];if(keywords.forEach(keyword=>{indexOfTitle=indexOfTitle.concat(getIndexByWord(keyword,titleInLowerCase,!1)),indexOfContent=indexOfContent.concat(getIndexByWord(keyword,contentInLowerCase,!1))}),indexOfTitle.length>0||indexOfContent.length>0){let hitCount=indexOfTitle.length+indexOfContent.length;[indexOfTitle,indexOfContent].forEach(index=>{index.sort((itemLeft,itemRight)=>itemRight.position!==itemLeft.position?itemRight.position-itemLeft.position:itemLeft.word.length-itemRight.word.length)});let slicesOfTitle=[];if(0!==indexOfTitle.length){let tmp=mergeIntoSlice(0,title.length,indexOfTitle,searchText);searchTextCount+=tmp.searchTextCountInSlice,slicesOfTitle.push(tmp)}let slicesOfContent=[];for(;0!==indexOfContent.length;){let item=indexOfContent[indexOfContent.length-1],{position:position,word:word}=item,start=position-20,end=position+80;start<0&&(start=0),end<position+word.length&&(end=position+word.length),end>content.length&&(end=content.length);let tmp=mergeIntoSlice(start,end,indexOfContent,searchText);searchTextCount+=tmp.searchTextCountInSlice,slicesOfContent.push(tmp)}slicesOfContent.sort((sliceLeft,sliceRight)=>sliceLeft.searchTextCount!==sliceRight.searchTextCount?sliceRight.searchTextCount-sliceLeft.searchTextCount:sliceLeft.hits.length!==sliceRight.hits.length?sliceRight.hits.length-sliceLeft.hits.length:sliceLeft.start-sliceRight.start);let upperBound=parseInt(CONFIG.localsearch.top_n_per_article,10);upperBound>=0&&(slicesOfContent=slicesOfContent.slice(0,upperBound));let resultItem="";0!==slicesOfTitle.length?resultItem+=`<li><a href="${articleUrl}" class="search-result-title">${highlightKeyword(title,slicesOfTitle[0])}</a>`:resultItem+=`<li><a href="${articleUrl}" class="search-result-title">${title}</a>`,slicesOfContent.forEach(slice=>{resultItem+=`<a href="${articleUrl}"><p class="search-result">${highlightKeyword(content,slice)}...</p></a>`}),resultItem+="</li>",resultItems.push({item:resultItem,searchTextCount:searchTextCount,hitCount:hitCount,id:resultItems.length})}}),1===keywords.length&&""===keywords[0])resultContent.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===resultItems.length)resultContent.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{resultItems.sort((resultLeft,resultRight)=>resultLeft.searchTextCount!==resultRight.searchTextCount?resultRight.searchTextCount-resultLeft.searchTextCount:resultLeft.hitCount!==resultRight.hitCount?resultRight.hitCount-resultLeft.hitCount:resultRight.id-resultLeft.id);let searchResultList='<ul class="search-result-list">';resultItems.forEach(result=>{searchResultList+=result.item}),searchResultList+="</ul>",resultContent.innerHTML=searchResultList,window.pjax&&window.pjax.refresh(resultContent)}},fetchData=callback=>{fetch(path).then(response=>response.text()).then(res=>{isfetched=!0,datas=isXml?[...(new DOMParser).parseFromString(res,"text/xml").querySelectorAll("entry")].map(element=>({title:element.querySelector("title").innerHTML,content:element.querySelector("content").innerHTML,url:element.querySelector("url").innerHTML})):JSON.parse(res),document.querySelector(".search-pop-overlay").innerHTML="",document.body.style.overflow="",callback&&callback()})};CONFIG.localsearch.preload&&fetchData();const proceedSearch=()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").style.display="block",document.querySelector(".popup").style.display="block",document.getElementById("search-input").focus()};"auto"===CONFIG.localsearch.trigger?input.addEventListener("input",inputEventFunction):(document.querySelector(".search-icon").addEventListener("click",inputEventFunction),input.addEventListener("keypress",event=>{13===event.keyCode&&inputEventFunction()})),document.querySelector(".popup-trigger").addEventListener("click",()=>{!1===isfetched?(document.querySelector(".search-pop-overlay").style.display="",document.querySelector(".search-pop-overlay").innerHTML='<div class="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div>',fetchData(proceedSearch)):proceedSearch()});const onPopupClose=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").style.display="none",document.querySelector(".popup").style.display="none"};document.querySelector(".search-pop-overlay").addEventListener("click",onPopupClose),document.querySelector(".popup-btn-close").addEventListener("click",onPopupClose),window.addEventListener("pjax:success",onPopupClose),window.addEventListener("keyup",event=>{27===event.which&&onPopupClose()})});